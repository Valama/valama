cmake_minimum_required(VERSION "2.8.4")

list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/buildsystems/valama-codecontextd/cmake/cmake_modules")
list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/buildsystems/valama-codecontextd/cmake/cmake_modules/vala")

find_package(PkgConfig)
find_package(Vala)

set(project_name "valama-codecontextd")
string(TOLOWER "${project_name}" project_name_lower)

set(srcfiles
  "codecontextd/main.vala"
  "codecontextd/Report.vala"
  "codecontextd/Error.vala"
  "src/Units/Completion/guanako.vala"
  "src/Units/Completion/guanako_iterators.vala"
  "src/Units/Completion/guanako_helpers.vala"
)

message ("-- checking dependency gio-2.0")
set (found FALSE)
if (NOT found)
  message ("--  checking option gio-2.0")
  set (cond_found TRUE)
  pkg_check_modules (DEP_gio-2.0 QUIET gio-2.0)
  if (NOT DEP_gio-2.0_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "gio-2.0")
  endif ()
endif ()
if (NOT found)
  message ("PROBLEM!!")
endif ()

message ("-- checking dependency LibVala")
set (found FALSE)
if (NOT found)
  message ("--  checking option libvala-0.32")
  set (cond_found TRUE)
  pkg_check_modules (DEP_libvala-0.32 QUIET libvala-0.32)
  if (NOT DEP_libvala-0.32_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "libvala-0.32")
  endif ()
endif ()
if (NOT found)
  message ("--  checking option libvala-0.30")
  set (cond_found TRUE)
  pkg_check_modules (DEP_libvala-0.30 QUIET libvala-0.30)
  if (NOT DEP_libvala-0.30_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "libvala-0.30")
  endif ()
endif ()
if (NOT found)
  message ("--  checking option libvala-0.28")
  set (cond_found TRUE)
  pkg_check_modules (DEP_libvala-0.28 QUIET libvala-0.28)
  if (NOT DEP_libvala-0.28_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "libvala-0.28")
  endif ()
endif ()
if (NOT found)
  message ("--  checking option libvala-0.26")
  set (cond_found TRUE)
  pkg_check_modules (DEP_libvala-0.26 QUIET libvala-0.26)
  if (NOT DEP_libvala-0.26_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "libvala-0.26")
  endif ()
endif ()
if (NOT found)
  message ("--  checking option libvala-0.24")
  set (cond_found TRUE)
  pkg_check_modules (DEP_libvala-0.24 QUIET libvala-0.24)
  if (NOT DEP_libvala-0.24_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "libvala-0.24")
  endif ()
endif ()
if (NOT found)
  message ("--  checking option libvala-0.22")
  set (cond_found TRUE)
  pkg_check_modules (DEP_libvala-0.22 QUIET libvala-0.22)
  if (NOT DEP_libvala-0.22_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "libvala-0.22")
  endif ()
endif ()
if (NOT found)
  message ("PROBLEM!!")
endif ()

message ("-- checking dependency gee-0.8")
set (found FALSE)
if (NOT found)
  message ("--  checking option gee-0.8")
  set (cond_found TRUE)
  pkg_check_modules (DEP_gee-0.8 QUIET gee-0.8)
  if (NOT DEP_gee-0.8_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "gee-0.8")
  endif ()
endif ()
if (NOT found)
  message ("PROBLEM!!")
endif ()

message ("-- checking dependency GTK+3")
set (found FALSE)
if (NOT found)
  message ("--  checking option gtk+-3.0")
  set (cond_found TRUE)
  pkg_check_modules (DEP_gtk+-3.0 QUIET gtk+-3.0)
  if (NOT DEP_gtk+-3.0_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "gtk+-3.0")
  endif ()
endif ()
if (NOT found)
  message ("PROBLEM!!")
endif ()

message ("-- checking dependency gtksourceview-3.0")
set (found FALSE)
if (NOT found)
  message ("--  checking option gtksourceview-3.0")
  set (cond_found TRUE)
  pkg_check_modules (DEP_gtksourceview-3.0 QUIET gtksourceview-3.0)
  if (NOT DEP_gtksourceview-3.0_VERSION)
    set (cond_found FALSE)
  endif ()
  if (cond_found)
    set (found TRUE)
    list(APPEND required_pkgs "gtksourceview-3.0")
  endif ()
endif ()
if (NOT found)
  message ("PROBLEM!!")
endif ()

list(APPEND vapifiles "buildsystems/valama-codecontextd/config.vapi")
install(FILES "src/Units/Completion/syntax" DESTINATION "${CMAKE_INSTALL_PREFIX}/share/valama/guanako/" RENAME "syntax")
add_definitions(-DDATA_DIR="${CMAKE_INSTALL_PREFIX}")

# Gettext

add_definitions(-DGETTEXT_PACKAGE="")

add_definitions(-DGETTEXT_PACKAGE_DOMAIN="${CMAKE_INSTALL_PREFIX}/share/locale")

set(default_vala_flags
  "--thread"
  "--target-glib=2.38"
  "--enable-experimental"
)

include(ValaPkgs)
vala_pkgs(VALA_C
  PACKAGES
    ${required_pkgs}
  DEFINITIONS
    ${definitions}
  SRCFILES
    ${srcfiles}
  VAPIS
    ${vapifiles}
  OPTIONS
    ${default_vala_flags}
    ${vapidirs}
)

add_executable("${project_name_lower}" ${VALA_C} ${compiled_resources} ${compiled_gettext})
install(TARGETS "${project_name_lower}" DESTINATION "${CMAKE_INSTALL_PREFIX}/bin")

target_link_libraries("${project_name_lower}"
  ${PROJECT_LDFLAGS}
  -lm
)

add_definitions(
  ${PROJECT_C_FLAGS}
)
